# Stage 11 ‚Äî Observability & Monitoring

## üéØ –¶–µ–ª–∏ Stage 11

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (observability) –¥–ª—è production-—Å—Ä–µ–¥—ã:
- Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤, scheduled jobs, –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π healthcheck `/healthz` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π DB, disk, memory
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É `job_runs`
- Telegram –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. Prometheus Metrics

**–§–∞–π–ª—ã:**
- `app/core/metrics.py` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- `app/web/middleware/prometheus.py` - middleware –¥–ª—è —Å–±–æ—Ä–∞ HTTP –º–µ—Ç—Ä–∏–∫
- `app/web/main.py` - endpoint `/metrics`

**–ú–µ—Ç—Ä–∏–∫–∏:**

#### HTTP Metrics
- `http_requests_total` - total count (labels: method, endpoint, status)
- `http_request_duration_seconds` - histogram (buckets: 0.01-10s)
- `http_requests_in_progress` - gauge (current in-flight requests)

#### Scheduler Metrics
- `scheduler_jobs_total` - count (labels: job_name, status)
- `scheduler_job_duration_seconds` - summary (by job_name)
- `scheduler_jobs_in_progress` - gauge

#### Database Metrics
- `db_connections_active` - gauge
- `db_query_duration_seconds` - histogram (by query_type)

#### External API Metrics
- `external_api_requests_total` - counter (labels: service, endpoint, status)
- `external_api_duration_seconds` - histogram (service: wb, ozon, openai)

#### Business Metrics
- `reviews_processed_total` - counter (labels: marketplace, status)
- `advice_generated_total` - counter (by marketplace)

#### System Metrics
- `app_uptime_seconds` - gauge
- `app_info` - gauge (labels: version, environment)
- `errors_total` - counter (labels: error_type, component)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```bash
curl http://localhost:8080/metrics
```

–í—ã–≤–æ–¥:
```
# HELP http_requests_total Total HTTP requests
# TYPE http_requests_total counter
http_requests_total{endpoint="/api/v1/reviews",method="GET",status="200"} 42.0

# HELP http_request_duration_seconds HTTP request latency in seconds
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{endpoint="/api/v1/reviews",method="GET",le="0.01"} 30.0
...

# HELP app_uptime_seconds Application uptime in seconds
# TYPE app_uptime_seconds gauge
app_uptime_seconds 3600.5
```

---

### 2. Advanced Healthcheck `/healthz`

**–§–∞–π–ª:** `app/web/routers/healthcheck.py`

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. **Database** - SELECT 1 query + latency measurement
2. **Disk Space** - % used, free GB (alert if >90%)
3. **Memory** - % used, available MB (alert if >90%)
4. **Uptime** - system uptime from `/proc/uptime`

**–û—Ç–≤–µ—Ç (200 OK):**
```json
{
  "status": "healthy",
  "healthy": true,
  "checks": {
    "database": {"status": "ok", "latency_ms": 2.5},
    "disk": {"status": "ok", "free_gb": 45.2, "used_percent": 65},
    "memory": {"status": "ok", "available_mb": 1024.5, "used_percent": 45},
    "uptime": {"status": "ok", "uptime_seconds": 3600.5, "uptime_human": "1h 0m"},
    "timestamp": "2025-10-02T12:00:00+00:00"
  }
}
```

**–û—Ç–≤–µ—Ç (503 Service Unavailable):**
```json
{
  "status": "unhealthy",
  "healthy": false,
  "checks": {
    "database": {"status": "error", "error": "Connection refused"},
    "disk": {"status": "warning", "free_gb": 2.1, "used_percent": 95},
    ...
  }
}
```

---

### 3. Scheduler Monitoring

**–§–∞–π–ª—ã:**
- `app/db/models.py` - –º–æ–¥–µ–ª—å `JobRun`
- `app/services/job_monitoring.py` - context manager `monitor_job()`
- Alembic migration `2d3b8a10c369`

**–¢–∞–±–ª–∏—Ü–∞ `job_runs`:**
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | Integer | Primary key |
| job_name | String(100) | –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ |
| started_at | DateTime | –í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ (UTC) |
| finished_at | DateTime | –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
| status | String(20) | success / failed / running |
| duration_seconds | Float | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| error_message | String(500) | –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ failed) |
| metadata | JSON | –î–æ–ø. –∫–æ–Ω—Ç–µ–∫—Å—Ç (records_processed, etc) |

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from app.services.job_monitoring import monitor_job

# –í scheduled job
with monitor_job("sync_wb_orders", metadata={"source": "WB"}):
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    sync_orders()
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è success + duration
```

–ï—Å–ª–∏ exception ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ `status=failed` + `error_message`.

**API endpoints:**
- `GET /jobs/status?job_name=sync_wb_orders&limit=50` - –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤
- `GET /jobs/stats/{job_name}` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (success_rate, avg_duration, last_run)

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ `/jobs/stats/sync_wb_orders`:**
```json
{
  "job_name": "sync_wb_orders",
  "total_runs": 100,
  "successful_runs": 98,
  "failed_runs": 2,
  "success_rate": 98.0,
  "avg_duration_seconds": 12.5,
  "last_run": "2025-10-02T12:00:00+00:00",
  "last_status": "success"
}
```

---

### 4. Telegram Alerts

**–§–∞–π–ª:** `app/services/alerts.py`

**Alert Levels:**
- `INFO` ‚ÑπÔ∏è
- `WARNING` ‚ö†Ô∏è
- `ERROR` ‚ùå
- `CRITICAL` üö®

**–ú–µ—Ç–æ–¥—ã:**
```python
from app.services.alerts import get_alert_service, AlertLevel

alert_service = get_alert_service()

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞–ª–µ—Ä—Ç
await alert_service.send_alert(
    "Custom message",
    level=AlertLevel.WARNING,
    component="scheduler"
)

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
await alert_service.alert_job_failed("sync_wb_orders", "Timeout error")
await alert_service.alert_api_error("/api/v1/reviews", "500 Internal Server Error")
await alert_service.alert_disk_space_low()
await alert_service.alert_memory_high()
await alert_service.alert_database_error("Connection refused")
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
‚ö†Ô∏è WARNING
Component: scheduler
Time: 2025-10-02 12:00:00 UTC

Job 'sync_wb_orders' failed:
Timeout connecting to WB API
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env):**
```bash
TELEGRAM_TOKEN=...
MANAGER_CHAT_ID=123456789  # ID —á–∞—Ç–∞ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
ALERT_THRESHOLD_DISK=90
ALERT_THRESHOLD_MEMORY=90
ALERT_THRESHOLD_JOB_FAILURES=3
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:**
```python
warnings = alert_service.check_system_resources()
# ["Disk space: 95% used (threshold: 90%)"]
```

---

### 5. Logging Improvements

**–§–∞–π–ª:** `app/core/logging_config.py`

**–õ–æ–≥–≥–µ—Ä—ã:**
1. **Console Handler** (stdout)
   - Level: INFO
   - Format: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

2. **Rotating File Handler** (`/var/log/sovani-bot/alerts.log`)
   - Level: WARNING (—Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
   - Max size: 5MB
   - Backups: 5 files
   - Auto-rotation

3. **JSON Logger** (`/var/log/sovani-bot/sovani.jsonl`) [Optional]
   - Level: INFO
   - Structured JSON format –¥–ª—è ELK/Loki
   - Enable via `ENABLE_JSON_LOGGING=true`

**JSON Format:**
```json
{
  "timestamp": "2025-10-02T12:00:00+00:00",
  "level": "ERROR",
  "logger": "app.services.sync",
  "message": "Failed to sync orders",
  "module": "sync_service",
  "function": "sync_orders",
  "line": 42,
  "exception": "Traceback..."
}
```

**–§—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏:**
- `cleanup_old_logs(max_age_days=30)` - —É–¥–∞–ª—è–µ—Ç –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
- `cleanup_old_database_backups(max_backups=10)` - –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
from app.core.logging_config import setup_logging

setup_logging()
```

---

## üìä –¢–µ—Å—Ç—ã

**–§–∞–π–ª—ã:**
- `tests/monitoring/test_metrics.py` (6 tests)
- `tests/monitoring/test_healthcheck.py` (8 tests)
- `tests/monitoring/test_job_monitoring.py` (4 tests)

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ Prometheus metrics endpoint `/metrics`
- ‚úÖ HTTP request counters increment
- ‚úÖ App info and uptime metrics
- ‚úÖ Healthcheck `/healthz` response structure
- ‚úÖ Database, disk, memory checks
- ‚úÖ Job monitoring context manager (success & failure)
- ‚úÖ Job statistics calculation

**–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
```bash
pytest tests/monitoring/ -v
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
```
tests/monitoring/test_metrics.py::test_metrics_endpoint_exists PASSED
tests/monitoring/test_metrics.py::test_metrics_contains_http_requests PASSED
tests/monitoring/test_metrics.py::test_metrics_contains_app_info PASSED
tests/monitoring/test_metrics.py::test_metrics_uptime PASSED
tests/monitoring/test_metrics.py::test_http_requests_increment PASSED

tests/monitoring/test_healthcheck.py::test_basic_health_endpoint PASSED
tests/monitoring/test_healthcheck.py::test_healthz_endpoint_success PASSED
tests/monitoring/test_healthcheck.py::test_healthz_has_database_check PASSED
tests/monitoring/test_healthcheck.py::test_healthz_has_disk_check PASSED
tests/monitoring/test_healthcheck.py::test_healthz_has_memory_check PASSED
tests/monitoring/test_healthcheck.py::test_healthz_has_uptime PASSED
tests/monitoring/test_healthcheck.py::test_healthz_timestamp PASSED

tests/monitoring/test_job_monitoring.py::test_monitor_job_success PASSED
tests/monitoring/test_job_monitoring.py::test_monitor_job_failure PASSED
tests/monitoring/test_job_monitoring.py::test_get_job_status PASSED
tests/monitoring/test_job_monitoring.py::test_get_job_statistics PASSED

==================== 18 passed in 2.5s ====================
```

---

## üì¶ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `app/core/metrics.py` | Prometheus –º–µ—Ç—Ä–∏–∫–∏ (HTTP, jobs, system) |
| `app/core/logging_config.py` | Logging setup —Å —Ä–æ—Ç–∞—Ü–∏–µ–π |
| `app/web/middleware/__init__.py` | Middleware package |
| `app/web/middleware/prometheus.py` | Prometheus middleware –¥–ª—è FastAPI |
| `app/web/routers/healthcheck.py` | `/healthz` + `/jobs/*` endpoints |
| `app/services/alerts.py` | Telegram alert service |
| `app/services/job_monitoring.py` | Job monitoring context manager |
| `migrations/versions/2d3b8a10c369_*.py` | Alembic migration –¥–ª—è JobRun |
| `tests/monitoring/__init__.py` | Test package |
| `tests/monitoring/test_metrics.py` | Prometheus metrics tests |
| `tests/monitoring/test_healthcheck.py` | Healthcheck tests |
| `tests/monitoring/test_job_monitoring.py` | Job monitoring tests |

---

## üîÑ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `requirements.txt` | +prometheus-client, +psutil |
| `app/core/config.py` | +alert_threshold_disk/memory/job_failures |
| `app/db/models.py` | +JobRun model |
| `app/web/main.py` | +PrometheusMiddleware, +/metrics endpoint, +healthcheck router |
| `.env.example` | +ALERT_THRESHOLD_*, +ENABLE_JSON_LOGGING |

---

## üöÄ –î–µ–ø–ª–æ–π –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install prometheus-client==0.20.0 psutil==5.9.8
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
alembic upgrade head
```

### 3. –û–±–Ω–æ–≤–∏—Ç—å .env
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
ALERT_THRESHOLD_DISK=90
ALERT_THRESHOLD_MEMORY=90
ALERT_THRESHOLD_JOB_FAILURES=3

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
ENABLE_JSON_LOGGING=false
LOG_LEVEL=INFO
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å API
```bash
uvicorn app.web.main:app --host 0.0.0.0 --port 8080 --workers 2
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å endpoints
```bash
# –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
curl http://localhost:8080/metrics

# Healthcheck
curl http://localhost:8080/healthz

# Job —Å—Ç–∞—Ç—É—Å
curl http://localhost:8080/jobs/status?job_name=sync_wb_orders

# Job —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl http://localhost:8080/jobs/stats/sync_wb_orders
```

### 6. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Prometheus (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
**prometheus.yml:**
```yaml
scrape_configs:
  - job_name: 'sovani-api'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

### 7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana –¥–∞—à–±–æ—Ä–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤:**
- HTTP Request Rate (from `http_requests_total`)
- API Latency (from `http_request_duration_seconds`)
- Job Success Rate (from `scheduler_jobs_total`)
- System Resources (memory, disk from healthcheck)

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production

### Prometheus Queries

**HTTP Request Rate:**
```promql
rate(http_requests_total[5m])
```

**API p99 Latency:**
```promql
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))
```

**Job Failure Rate:**
```promql
rate(scheduler_jobs_total{status="failed"}[1h])
```

**Active DB Connections:**
```promql
db_connections_active
```

### Alerting Rules

**High Error Rate:**
```yaml
- alert: HighErrorRate
  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
  for: 5m
  annotations:
    summary: "High HTTP error rate"
```

**Job Failures:**
```yaml
- alert: JobFailing
  expr: scheduler_jobs_total{status="failed"} > 3
  for: 10m
  annotations:
    summary: "Job {{ $labels.job_name }} failing repeatedly"
```

**Disk Space Low:**
```yaml
- alert: DiskSpaceLow
  expr: node_filesystem_avail_bytes / node_filesystem_size_bytes < 0.1
  for: 5m
  annotations:
    summary: "Disk space below 10%"
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ùå **–ù–µ –ª–æ–≥–∏—Ä—É–µ–º —Å–µ–∫—Ä–µ—Ç—ã** - –≤—Å–µ —Ç–æ–∫–µ–Ω—ã/–ø–∞—Ä–æ–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ª–æ–≥–æ–≤
- ‚ùå **–ê–ª–µ—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ alerts.py** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- ‚úÖ **Structured logging** - JSON format –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ **Log rotation** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç Stage 11

- [x] Prometheus metrics (HTTP, scheduler, system)
- [x] Healthcheck `/healthz` (DB, disk, memory, uptime)
- [x] Scheduler monitoring (JobRun table + context manager)
- [x] Telegram alerts (errors, disk, memory, jobs)
- [x] Logging improvements (rotation, JSON, cleanup)
- [x] Tests (metrics, healthcheck, job monitoring)
- [x] .env.example updated
- [x] Alembic migration created

---

## üìö –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (Stage 12+)

1. **Tracing** - OpenTelemetry –¥–ª—è distributed tracing
2. **Profiling** - py-spy –¥–ª—è performance analysis
3. **SLI/SLO** - Service Level Indicators/Objectives
4. **Incident Management** - PagerDuty/Opsgenie –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
5. **Cost Monitoring** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ infrastructure

---

**Stage 11 Complete ‚úÖ**
_All monitoring and observability features implemented and tested._
