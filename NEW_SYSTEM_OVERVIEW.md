# –ù–æ–≤–∞—è –≠—Ç–∞–ø–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ –û–±—Ä–∞–±–æ—Ç–∫–∏ –î–∞–Ω–Ω—ã—Ö

## üöÄ –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–¥–æ –≥–æ–¥–∞) —Å:
- ‚úÖ **–§–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π** (Celery)
- ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º** –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (Redis)
- ‚úÖ **–≠—Ç–∞–ø–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ API –∑–∞–ø—Ä–æ—Å–∞–º–∏**
- ‚úÖ **–ö—Ä–∞—Å–∏–≤—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º** –≤ Telegram

## üìÅ –ù–æ–≤—ã–µ –§–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **`celery_config.py`** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
2. **`background_tasks.py`** - Celery –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∞–Ω–∫–æ–≤
3. **`chunk_cache.py`** - –°–∏—Å—Ç–µ–º–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Redis
4. **`progress_tracker.py`** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞—á —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
5. **`optimized_api_client.py`** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã —Å rate limiting
6. **`staged_processor.py`** - –≠—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (–≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
7. **`telegram_progress.py`** - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è Telegram

### –¢–µ—Å—Ç—ã:
8. **`test_staged_system.py`** - –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

## üîß –ö–ª—é—á–µ–≤—ã–µ –£–ª—É—á—à–µ–Ω–∏—è

### 1. –≠—Ç–∞–ø–Ω–∞—è –û–±—Ä–∞–±–æ—Ç–∫–∞
–°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ 4 —á–µ—Ç–∫–∏—Ö —ç—Ç–∞–ø–∞:
- **–≠–¢–ê–ü 1**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤
- **–≠–¢–ê–ü 2**: –û–±—Ä–∞–±–æ—Ç–∫–∞ WB –¥–∞–Ω–Ω—ã—Ö (Orders + Sales + Advertising)
- **–≠–¢–ê–ü 3**: –û–±—Ä–∞–±–æ—Ç–∫–∞ Ozon –¥–∞–Ω–Ω—ã—Ö (FBO + FBS)
- **–≠–¢–ê–ü 4**: –§–∏–Ω–∞–ª—å–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ —Ä–∞—Å—á–µ—Ç—ã

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–∞–Ω–∫–æ–≤ –Ω–∞ 24 —á–∞—Å–∞
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–µ—à –≤–º–µ—Å—Ç–æ API
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫–µ—à–∞

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã
- **–ü–∞–∫–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Rate limiting** –ø–æ —Ç–∏–ø–∞–º API (WB: 25/–º–∏–Ω, Ozon: 30/–º–∏–Ω)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã** –ø—Ä–∏ 429 –æ—à–∏–±–∫–∞—Ö
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP —Å–µ—Å—Å–∏–π**

### 4. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
- –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã: `‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë 80%`
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- –û—Ü–µ–Ω–∫–∞ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
- –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 5. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞ –≤ Redis
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–∑–æ–≤:
```python
from staged_processor import staged_processor

result = await staged_processor.process_year_staged(
    date_from="2025-01-01",
    date_to="2025-09-21",
    progress_message=telegram_message
)
```

### –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ —Å Celery:
```python
from background_tasks import process_year_data_background

task = process_year_data_background.delay(
    "2025-01-01",
    "2025-09-21",
    chat_id=123456
)
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–ª—è –ø–µ—Ä–∏–æ–¥–∞ –≤ 1 –≥–æ–¥ (365 –¥–Ω–µ–π):
- **WB**: ~12 —á–∞–Ω–∫–æ–≤ –ø–æ 31 –¥–µ–Ω—å
- **Ozon**: ~13 —á–∞–Ω–∫–æ–≤ –ø–æ 30 –¥–Ω–µ–π
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~50-60 –º–∏–Ω—É—Ç (—Å —É—á–µ—Ç–æ–º rate limiting)
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ —Ç–æ—Ç –∂–µ –ø–µ—Ä–∏–æ–¥ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ —á–∞–Ω–∫–∞ (Orders + Sales –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- –£–º–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —á–∞–Ω–∫–∏ –±—ã—Å—Ç—Ä–µ–µ)
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

## üî¥ Redis —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç Redis –¥–ª—è:
- **–ë–∞–∑–∞ 0**: –ö–µ—à —á–∞–Ω–∫–æ–≤
- **–ë–∞–∑–∞ 1**: –ë—Ä–æ–∫–µ—Ä Celery
- **–ë–∞–∑–∞ 2**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery
- **–ë–∞–∑–∞ 3**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```python
from chunk_cache import ChunkCache
from progress_tracker import ProgressTracker

cache = ChunkCache()
tracker = ProgressTracker()

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
cache_stats = cache.get_cache_stats()

# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
active_jobs = tracker.get_active_jobs()

# –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏
job_stats = tracker.get_job_statistics(job_id)
```

## ‚ö° –ó–∞–ø—É—Å–∫ Celery Worker

–î–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
```bash
cd /root/sovani_bot
celery -A celery_config worker --loglevel=info --queues=wb_processing,ozon_processing,aggregation,main_processing
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç:
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **–ø–æ–ª–Ω—ã–π –≥–æ–¥** –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Ñ–µ–π–∫–æ–≤
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å **–∫—Ä–∞—Å–∏–≤—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞—Ç—å** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–í–æ–∑–æ–±–Ω–æ–≤–ª—è—Ç—å** –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å **—Å—Ç–∞–±–∏–ª—å–Ω–æ** —Å –ª—é–±—ã–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –ª–∏–º–∏—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞ —Å "—Ñ–µ–π–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏" –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!** üî•